name: notify_frequencia.yml

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: America/Sao_Paulo
      # === Secrets obrigatÃ³rios ===
      GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}   # JSON inteiro
      SHEET_ID: ${{ secrets.SHEET_ID }}                         # 1qtOF1...IUE
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      # (Opcional) debug extra nos logs:
      # ACTIONS_STEP_DEBUG: ${{ secrets.ACTIONS_STEP_DEBUG }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show env (safe)
        run: |
          echo "TZ=$TZ"
          echo "SHEET_ID set? $([ -n "$SHEET_ID" ] && echo YES || echo NO)"
          echo "TELEGRAM_TOKEN set? $([ -n "$TELEGRAM_TOKEN" ] && echo YES || echo NO)"
          echo "TELEGRAM_CHAT_ID set? $([ -n "$TELEGRAM_CHAT_ID" ] && echo YES || echo NO)"
          echo "GCP_SERVICE_ACCOUNT length: ${#GCP_SERVICE_ACCOUNT}"

      - name: Prepare Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas gspread gspread_dataframe google-auth requests pytz

      - name: Write GCP creds to file
        run: |
          echo "$GCP_SERVICE_ACCOUNT" > sa.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/sa.json" >> $GITHUB_ENV

      - name: Run notifier (manual por cliente)
        run: |
          set -xe
          python scripts/notify_frequencia.py
